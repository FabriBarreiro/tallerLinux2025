# hardening.yml
- name: Hardening básico de Ubuntu
  hosts: ubuntu
  become: true

  collections:
    - community.general # para el módulo ufw

  vars:
    sshd_config: /etc/ssh/sshd_config

  tasks:
    # Actualizar cache y luego paquetes
    # Refresca índices de APT (equivalente a apt update)
    - name: Actualizar lista de paquetes APT (apt update)
      ansible.builtin.apt:
        update_cache: true
      register: apt_update_result

    # Actualiza paquetes instalados
    - name: Actualizar paquetes instalados (apt upgrade)
      ansible.builtin.apt:
        upgrade: yes
      register: apt_upgrade_result
      notify: Evaluar reinicio si hubo actualizaciones

    # Chequea si el sistema requiere reinicio
    - name: Comprobar si el sistema requiere reinicio (Ubuntu)
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    # UFW habilitado: bloquear entrante, permitir solo SSH
    # Instala UFW si falta
    - name: Asegurar paquete ufw instalado
      ansible.builtin.package:
        name: ufw
        state: present

    # Habilita UFW y bloquea todo el tráfico entrante por defecto
    - name: UFW - política por defecto (deny incoming / allow outgoing)
      community.general.ufw:
        state: enabled
        direction: incoming
        policy: deny

    - name: Asegurar que OpenSSH está instalado
      apt:
        name: openssh-server
        state: present
        update_cache: yes
      become: yes

    # Permite acceso SSH
    - name: UFW - permitir OpenSSH
      community.general.ufw:
        rule: allow
        name: OpenSSH

    # Mantiene todo el tráfico saliente permitido
    - name: UFW - asegurar allow para salida
      community.general.ufw:
        direction: outgoing
        policy: allow
        state: enabled

    # 3) SSH solo con clave pública y root sin login
    # Fuerza autenticación solo por clave; deshabilita contraseñas en SSH
    - name: SSH - deshabilitar PasswordAuthentication
      ansible.builtin.lineinfile:
        path: "{{ sshd_config }}"
        regexp: '^[#\s]*PasswordAuthentication\s+'
        line: "PasswordAuthentication no"
        create: no
      notify: Reiniciar SSH si cambió configuración

    # Bloquea el login SSH directo del usuario root
    - name: SSH - deshabilitar PermitRootLogin
      ansible.builtin.lineinfile:
        path: "{{ sshd_config }}"
        regexp: '^[#\s]*PermitRootLogin\s+'
        line: "PermitRootLogin no"
        create: no
      notify: Reiniciar SSH si cambió configuración

    # Crea un archivo "drop-in" en /etc/ssh/sshd_config.d con prioridad alta (99-*)
    # para sobrescribir configuraciones del archivo 50-cloud-init.conf.
    # Esto garantiza que PasswordAuthentication y PermitRootLogin queden en "no"
    # Es la forma recomendada por OpenSSH para aplicar cambios persistentes sin modificar archivos base.
    - name: SSH - crear drop-in 99-hardening.conf con valores finales
      ansible.builtin.copy:
        dest: /etc/ssh/sshd_config.d/99-hardening.conf
        content: |
          PasswordAuthentication no
          PermitRootLogin no
        owner: root
        group: root
        mode: "0644"
      notify: Reiniciar SSH si cambió configuración

    # Instala fail2ban para mitigar intentos de fuerza bruta
    - name: Instalar fail2ban
      ansible.builtin.package:
        name: fail2ban
        state: present

    # Activa y arranca el servicio fail2ban
    - name: Habilitar y arrancar fail2ban
      ansible.builtin.service:
        name: fail2ban
        enabled: true
        state: started

  handlers:
    # Handler: reinicia el equipo si hubo actualizaciones y el sistema lo requiere
    - name: Evaluar reinicio si hubo actualizaciones
      ansible.builtin.reboot:
        msg: "Reinicio automático post-actualización"
        reboot_timeout: 900
      when: reboot_required_file.stat.exists | default(false)

    # Handler: reinicia el servicio SSH cuando se modificó sshd_config
    - name: Reiniciar SSH si cambió configuración
      ansible.builtin.service:
        name: ssh # en Ubuntu el servicio es 'ssh'
        state: restarted
